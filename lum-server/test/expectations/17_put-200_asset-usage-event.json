{
    "db": [
        {
            "sqlCmd": "BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ",
            "result": {"command": "BEGIN", "rowCount": 1, "rows": []}
        },
        {
            "sqlCmd": "SELECT TXID_CURRENT() AS txid, PG_BACKEND_PID() AS pid, NOW() AS tx_now",
            "result": {"command": "SELECT", "rowCount": 1,
                "rows": [{"txid": 123, "pid": 456, "tx_now": "__to_date__|2019-12-19T11:43:20.952Z"}]
            }
        },
        {
            "sqlCmd": "INSERT INTO \"assetUsageReq\" (\"assetUsageReqId\" , \"action\",\"assetUsageType\",\"requestHttp\",\"request\",\"userId\",\"status\", \"requestStarted\") VALUES (($1) , ($2),($3),($4),($5),($6),($7), NOW())",
            "sqlVals": [
                "06550414-d590-4fb3-8bbd-1ac3f99b906a",
                "add-event",
                "assetUsageEvent",
                {
                    "method": "PUT",
                    "requestUrl": "__type__ignore__",
                    "query": {
                        "assetUsageId": "alex-usage-1"
                    },
                    "Content-Type": "application/json; charset=utf-8",
                    "remoteAddress": "__type__ignore__",
                    "ip": "__type__ignore__",
                    "ips": []
                },
                {
                    "userId": "alex-event",
                    "requestId": "06550414-d590-4fb3-8bbd-1ac3f99b906a",
                    "requested": "2019-12-26T12:18:44.828Z",
                    "swMgtSystemId": "alex-sys",
                    "swMgtSystemInstanceId": "123",
                    "swMgtSystemComponent": "dev",
                    "assetUsageEvent": {
                        "swTagId": "alex-1",
                        "assetUsageId": "alex-usage-1",
                        "action": "add-event",
                        "event": {
                            "event-test": "got it"
                        }
                    }
                },
                "alex-event",
                "started"
            ],
            "result": {"command":"INSERT","rowCount":1,"rows":[]}
        },
        {
            "sqlCmd": "SELECT \"swTagId\", \"swPersistentId\",\"swVersion\",\"swVersionComparable\",\"licenseProfileId\",\"softwareLicensorId\",\"swCategory\",\"swCreators\",\"swProductName\",\"swidTagDetails\",\"swCatalogs\",\"swidTagRevision\",\"swidTagActive\",\"creator\",\"created\",\"modifier\",\"modified\",\"closer\",\"closed\",\"closureReason\" FROM \"swidTag\" WHERE \"swTagId\" IN (($1)) FOR SHARE",
            "sqlVals": ["alex-1"],
            "result": {"command": "SELECT", "rowCount": 1,
                "rows": [
                    {
                        "swTagId": "alex-1",
                        "swPersistentId": "fab0954c-d4e5-443a-8d3e-cf7620e80455",
                        "swVersion": "1",
                        "swVersionComparable": "1",
                        "licenseProfileId": "d817cbd1-d799-44af-8a5e-693163812e98",
                        "softwareLicensorId": "swlic",
                        "swCategory": "image-processing",
                        "swCreators": [
                            "alex-sw-creator-unit-test"
                        ],
                        "swProductName": "alex-product2020",
                        "swidTagDetails": null,
                        "swCatalogs": [
                            {
                                "swCatalogId": "XYZ models",
                                "swCatalogType": "restricted"
                            },
                            {
                                "swCatalogId": "ABC models",
                                "swCatalogType": "restricted"
                            }
                        ],
                        "swidTagRevision": 4,
                        "swidTagActive": true,
                        "creator": "alex-dev",
                        "created": "2019-10-23T15:14:21.888Z",
                        "modifier": "alex--creator",
                        "modified": "2019-12-20T16:57:34.119Z",
                        "closer": null,
                        "closed": null,
                        "closureReason": null
                    }
                ]
            }
        },
        {
            "sqlCmd": "SELECT \"licenseProfileId\", \"licenseProfile\",\"isRtuRequired\",\"licenseTxt\",\"licenseName\",\"licenseDescription\",\"licenseNotes\",\"licenseProfileRevision\",\"licenseProfileActive\",\"creator\",\"created\",\"modifier\",\"modified\",\"closer\",\"closed\",\"closureReason\" FROM \"licenseProfile\" WHERE \"licenseProfileId\" IN (($1)) FOR SHARE",
            "sqlVals": ["d817cbd1-d799-44af-8a5e-693163812e98"],
            "result": {"command": "SELECT", "rowCount": 1,
                "rows": [
                    {
                        "licenseProfileId": "d817cbd1-d799-44af-8a5e-693163812e98",
                        "licenseProfile": null,
                        "isRtuRequired": true,
                        "licenseTxt": null,
                        "licenseName": null,
                        "licenseDescription": null,
                        "licenseNotes": null,
                        "licenseProfileRevision": 1,
                        "licenseProfileActive": true,
                        "creator": "alex-dev",
                        "created": "2019-10-23T15:14:21.888Z",
                        "modifier": "alex-dev",
                        "modified": "2019-10-23T15:14:21.888Z",
                        "closer": null,
                        "closed": null,
                        "closureReason": null
                    }
                ]
            }
        },
        {
            "sqlCmd": "WITH asset_usage AS ( INSERT INTO \"assetUsage\" AS au (\"assetUsageId\" , \"modifier\" , \"creator\", \"assetUsageSeqTail\", \"assetUsageSeqTailEvent\", \"created\", \"modified\") VALUES (($1) , ($2) , ($3), 1, 1, NOW(), NOW()) ON CONFLICT (\"assetUsageId\") DO UPDATE SET \"assetUsageSeqTail\" = au.\"assetUsageSeqTail\" + 1, \"assetUsageSeqTailEvent\" = au.\"assetUsageSeqTail\" + 1, \"modified\" = NOW() , \"modifier\" = ($2) RETURNING \"assetUsageSeqTail\") INSERT INTO \"assetUsageHistory\" AS auh (\"assetUsageId\" , \"swMgtSystemId\",\"swMgtSystemInstanceId\",\"swMgtSystemComponent\",\"assetUsageReqId\",\"action\",\"assetUsageType\",\"swTagId\",\"softwareLicensorId\",\"swidTagRevision\",\"licenseProfileId\",\"licenseProfileRevision\",\"isRtuRequired\" , \"creator\", \"assetUsageSeq\", \"created\") SELECT ($1) , ($4),($5),($6),($7),($8),($9),($10),($11),($12),($13),($14),($15) , ($3), \"assetUsageSeqTail\", NOW() FROM asset_usage RETURNING auh.\"assetUsageSeq\"",
            "sqlVals": [
                "alex-usage-1",
                "alex-event",
                "alex-event",
                "alex-sys",
                "123",
                "dev",
                "06550414-d590-4fb3-8bbd-1ac3f99b906a",
                "add-event",
                "assetUsageEvent",
                "alex-1",
                "swlic",
                4,
                "d817cbd1-d799-44af-8a5e-693163812e98",
                1,
                true
            ],
            "result": {"command":"INSERT","rowCount":1,"rows":[{"assetUsageSeq":27}]}
        },
        {
            "sqlCmd": "INSERT INTO \"usageMetrics\" AS ums (\"usageMetricsId\",\"usageType\" , \"action\" , \"modifier\",\"modifierRequestId\" , \"swTagId\",\"metrics\",\"usageMetricsRevision\",\"creator\",\"creatorRequestId\", \"created\", \"modified\") VALUES (($1),($2) , ($3) , ($6),($7) , ($8),($9),($10),($11),($12), NOW(), NOW()) , (($1),($2), 'use' , ($6),($7) , ($8),($9),($10),($11),($12), NOW(), NOW()) ON CONFLICT (\"usageMetricsId\",\"usageType\" , \"action\") DO UPDATE SET \"usageMetricsRevision\" = ums.\"usageMetricsRevision\" + 1, \"modified\" = NOW(), \"metrics\" = ums.metrics || JSONB_BUILD_OBJECT('count', ((ums.metrics->'count')::INTEGER + ($5))) || CASE WHEN (ums.metrics->'users')::JSONB ? ($4) THEN '{}'::JSONB ELSE JSONB_BUILD_OBJECT('users', (ums.metrics->'users')::JSONB || ('[\"' || ($4) || '\"]')::JSONB) END , \"modifier\" = ($6),\"modifierRequestId\" = ($7) RETURNING *",
            "sqlVals": [
                "alex-1",
                "assetUsageEvent",
                "add-event",
                "alex-event",
                1,
                "alex-event",
                "06550414-d590-4fb3-8bbd-1ac3f99b906a",
                "alex-1",
                {
                    "count": 1,
                    "users": [
                        "alex-event"
                    ]
                },
                1,
                "alex-event",
                "06550414-d590-4fb3-8bbd-1ac3f99b906a"
            ],
            "result": {"command": "INSERT", "rowCount": 2,
                "rows": [
                    {
                        "usageMetricsId": "alex-1",
                        "action": "add-event",
                        "usageType": "assetUsageEvent",
                        "swTagId": "alex-1",
                        "assetUsageRuleId": null,
                        "metrics": {
                            "count": 1,
                            "users": [
                                "alex-event"
                            ]
                        },
                        "usageMetricsRevision": 1,
                        "creator": "alex-event",
                        "created": "2019-12-26T17:18:54.007Z",
                        "creatorRequestId": "06550414-d590-4fb3-8bbd-1ac3f99b906a",
                        "modifier": "alex-event",
                        "modified": "2019-12-26T17:18:54.007Z",
                        "modifierRequestId": "06550414-d590-4fb3-8bbd-1ac3f99b906a"
                    },
                    {
                        "usageMetricsId": "alex-1",
                        "action": "use",
                        "usageType": "assetUsageEvent",
                        "swTagId": "alex-1",
                        "assetUsageRuleId": null,
                        "metrics": {
                            "count": 1,
                            "users": [
                                "alex-event"
                            ]
                        },
                        "usageMetricsRevision": 1,
                        "creator": "alex-event",
                        "created": "2019-12-26T17:18:54.007Z",
                        "creatorRequestId": "06550414-d590-4fb3-8bbd-1ac3f99b906a",
                        "modifier": "alex-event",
                        "modified": "2019-12-26T17:18:54.007Z",
                        "modifierRequestId": "06550414-d590-4fb3-8bbd-1ac3f99b906a"
                    }
                ]
            }
        },
        {
            "sqlCmd": "UPDATE \"assetUsageReq\" AS aur SET \"requestDone\" = TRUE, \"responseSent\" = CLOCK_TIMESTAMP() , \"responseHttpCode\" = ($2),\"response\" = ($3),\"status\" = ($4) WHERE aur.\"assetUsageReqId\" = ($1)",
            "sqlVals": [
                "06550414-d590-4fb3-8bbd-1ac3f99b906a",
                200,
                {
                    "userId": "alex-event",
                    "requestId": "06550414-d590-4fb3-8bbd-1ac3f99b906a",
                    "requested": "2019-12-26T12:18:44.828Z",
                    "swMgtSystemId": "alex-sys",
                    "swMgtSystemInstanceId": "123",
                    "swMgtSystemComponent": "dev",
                    "assetUsageEvent": {
                        "swTagId": "alex-1",
                        "assetUsageId": "alex-usage-1",
                        "action": "add-event",
                        "event": {
                            "event-test": "got it"
                        },
                        "assetUsageSeq": 27,
                        "softwareLicensorId": "swlic",
                        "swidTagRevision": 4,
                        "licenseProfileId": "d817cbd1-d799-44af-8a5e-693163812e98",
                        "licenseProfileRevision": 1,
                        "isRtuRequired": true
                    }
                },
                "responseSent"
            ],
            "result": {"command":"UPDATE","rowCount":1,"rows":[]}
        },
        {
            "sqlCmd": "COMMIT",
            "result": {"command": "COMMIT", "rowCount": 1, "rows": []}
        }
    ],
    "req": {
        "method": "PUT",
        "path": "/api/v1/asset-usage-event?assetUsageId=alex-usage-1",
        "content-type": "application/json; charset=utf-8",
        "send": {
            "userId": "alex-event",
            "requestId": "06550414-d590-4fb3-8bbd-1ac3f99b906a",
            "requested": "2019-12-26T12:18:44.828Z",
            "swMgtSystemId": "alex-sys",
            "swMgtSystemInstanceId": "123",
            "swMgtSystemComponent": "dev",
            "assetUsageEvent": {
                "swTagId": "alex-1",
                "assetUsageId": "alex-usage-1",
                "action": "add-event",
                "event": {
                    "event-test": "got it"
                }
            }
        }
    },
    "res": {
        "statusCode": 200,
        "body": {
            "userId": "alex-event",
            "requestId": "06550414-d590-4fb3-8bbd-1ac3f99b906a",
            "requested": "2019-12-26T12:18:44.828Z",
            "swMgtSystemId": "alex-sys",
            "swMgtSystemInstanceId": "123",
            "swMgtSystemComponent": "dev",
            "assetUsageEvent": {
                "swTagId": "alex-1",
                "assetUsageId": "alex-usage-1",
                "action": "add-event",
                "event": {
                    "event-test": "got it"
                },
                "assetUsageSeq": 27,
                "softwareLicensorId": "swlic",
                "swidTagRevision": 4,
                "licenseProfileId": "d817cbd1-d799-44af-8a5e-693163812e98",
                "licenseProfileRevision": 1,
                "isRtuRequired": true
            }
        }
    }
}
